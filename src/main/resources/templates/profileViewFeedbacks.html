<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function checkUserhasAccessToken() {
            var jwtToken = localStorage.getItem("jwtToken");
            return !!jwtToken;
        }
        if (!checkUserhasAccessToken()) {
            // 여기에서 로그인 페이지로 리디렉트하거나 경고를 표시할 수 있습니다.
            alert("로그인 후 이용해주세요.");
            window.location.href = '/login'; // 로그인 페이지로 리디렉트
        }

        $(document).ready(function () {
            if (!checkUserhasAccessToken()) {
                // 여기에서 로그인 페이지로 리디렉트하거나 경고를 표시할 수 있습니다.
                alert("로그인 후 이용해주세요.");
                window.location.href = '/login'; // 로그인 페이지로 리다이렉트
            }
            function saveRating(account, productId, feedbackId, selectedRating) {
                var url = '/api/users/' + account + '/ratingStar/' + productId + '/' + feedbackId;

                // Ajax로 서버에 데이터 전송
                $.ajax({
                    type: 'POST',
                    url: url,

                    contentType: "application/json; charset=utf-8", // Content-Type을 명시적으로 설정
                    data: JSON.stringify({ rating: parseFloat(selectedRating) }), // parseFloat로 형변환
                    beforeSend: function (xhr) {
                        var token = localStorage.getItem("jwtToken");
                        if (token) {
                            xhr.setRequestHeader("Authorization", token);
                        }
                    },
                    success: function (response) {
                        console.log("점수가 매겨졌습니다.", response);
                        // 성공적으로 저장되었을 때 필요한 로직 추가 (예: 화면 갱신)
                        alert(response.message); // 서버로부터 받은 메시지를 alert로 표시
                        window.location.href = '/api/users/' + account + '/myProducts/' + productId + '/feedbacks';
                    },
                    error: function (jqXHR) {
                        const errorMessage = jqXHR.responseJSON.errorMessage;
                        console.error(errorMessage);
                        // 에러 발생 시 필요한 로직 추가
                        alert(errorMessage);
                    }
                });
            }

        })
    </script>
    <title>Feedback Details</title>
</head>
<body>

<h1>피드백 세부 정보</h1>

<p>계정: <span th:text="${account}"></span></p>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>생성일</th>
        <th>유저 ID</th>
        <th>제품 ID</th>
        <th>평가</th>
        <th>세부 정보</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="feedback : ${feedbacks}">
        <td th:text="${feedback.id}"></td>
        <td th:text="${feedback.createdAt}"></td>
        <td th:text="${feedback.userId}"></td>
        <td th:text="${feedback.productId}"></td>
        <td th:text="${feedback.rating}"></td>
        <td>
            <ul>
                <li th:each="detail : ${feedback.feedbackDetailsList}">
                    <span th:text="${detail.response}"></span>
                </li>
            </ul>
        </td>
        <td>
            <!-- 평가 입력을 위한 폼 추가 -->
            <form th:action="@{'/api/users/' + ${account} + '/ratingStar/' + ${feedback.productId} + '/' + ${feedback.id}}"
                  method="post"
                  onsubmit="saveRating('${account}', '${feedback.productId}', '${feedback.id}', this.rating.value); return false;">
                <select name="rating" th:value="${selectedRating}">
                    <option value="0">0</option>
                    <option value="0.5">0.5</option>
                    <option value="1.0">1.0</option>
                    <option value="1.5">1.5</option>
                    <option value="2.0">2.0</option>
                    <option value="2.5">2.5</option>
                    <option value="3.0">3.0</option>
                    <option value="3.5">3.5</option>
                    <option value="4.0">4.0</option>
                    <option value="4.5">4.5</option>
                    <option value="5.0">5.0</option>
                </select>
                <button type="submit">평가 저장</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

</body>\
</html>
